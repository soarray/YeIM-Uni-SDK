!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i=t();for(var n in i)("object"==typeof exports?exports:e)[n]=i[n]}}(self,(()=>(()=>{var e={251:e=>{e.exports=class{constructor(e){if(void 0===e.WorkerId)throw new Error("lost WorkerId");(!e.BaseTime||e.BaseTime<0)&&(e.BaseTime=1667232e6),(!e.WorkerIdBitLength||e.WorkerIdBitLength<0)&&(e.WorkerIdBitLength=6),(!e.SeqBitLength||e.SeqBitLength<0)&&(e.SeqBitLength=6),(e.MaxSeqNumber<=0||void 0===e.MaxSeqNumber)&&(e.MaxSeqNumber=63),(!e.MinSeqNumber||e.MinSeqNumber<0)&&(e.MinSeqNumber=5),(!e.TopOverCostCount||e.TopOverCostCount<0)&&(e.TopOverCostCount=2e3),2!==e.Method?e.Method=1:e.Method=2,this.Method=BigInt(e.Method),this.BaseTime=BigInt(e.BaseTime),this.WorkerId=BigInt(e.WorkerId),this.WorkerIdBitLength=BigInt(e.WorkerIdBitLength),this.SeqBitLength=BigInt(e.SeqBitLength),this.MaxSeqNumber=BigInt(e.MaxSeqNumber),this.MinSeqNumber=BigInt(e.MinSeqNumber),this.TopOverCostCount=BigInt(e.TopOverCostCount);const t=this.WorkerIdBitLength+this.SeqBitLength,i=this.MinSeqNumber;this._TimestampShift=t,this._CurrentSeqNumber=i,this._LastTimeTick=0,this._TurnBackTimeTick=0,this._TurnBackIndex=0,this._IsOverCost=!1,this._OverCostCountInOneTerm=0}DoGenIdAction(e){}BeginOverCostAction(e){}EndOverCostAction(e){}BeginTurnBackAction(e){}EndTurnBackAction(e){}NextOverCostId(){const e=this.GetCurrentTimeTick();return e>this._LastTimeTick?(this._LastTimeTick=e,this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!1,this._OverCostCountInOneTerm=0,this.CalcId(this._LastTimeTick)):this._OverCostCountInOneTerm>=this.TopOverCostCount?(this._LastTimeTick=this.GetNextTimeTick(),this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!1,this._OverCostCountInOneTerm=0,this.CalcId(this._LastTimeTick)):this._CurrentSeqNumber>this.MaxSeqNumber?(this._LastTimeTick++,this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!0,this._OverCostCountInOneTerm++,this.CalcId(this._LastTimeTick)):this.CalcId(this._LastTimeTick)}NextNormalId(){const e=this.GetCurrentTimeTick();return e<this._LastTimeTick?(this._TurnBackTimeTick<1&&(this._TurnBackTimeTick=this._LastTimeTick-1,this._TurnBackIndex++,this._TurnBackIndex>4&&(this._TurnBackIndex=1),this.BeginTurnBackAction(this._TurnBackTimeTick)),this.CalcTurnBackId(this._TurnBackTimeTick)):(this._TurnBackTimeTick>0&&(this.EndTurnBackAction(this._TurnBackTimeTick),this._TurnBackTimeTick=0),e>this._LastTimeTick?(this._LastTimeTick=e,this._CurrentSeqNumber=this.MinSeqNumber,this.CalcId(this._LastTimeTick)):this._CurrentSeqNumber>this.MaxSeqNumber?(this.BeginOverCostAction(e),this._LastTimeTick++,this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!0,this._OverCostCountInOneTerm=1,this.CalcId(this._LastTimeTick)):this.CalcId(this._LastTimeTick))}CalcId(e){const t=BigInt(e<<this._TimestampShift)+BigInt(this.WorkerId<<this.SeqBitLength)+BigInt(this._CurrentSeqNumber);return this._CurrentSeqNumber++,t}CalcTurnBackId(e){const t=BigInt(e<<this._TimestampShift)+BigInt(this.WorkerId<<this.SeqBitLength)+BigInt(this._TurnBackIndex);return this._TurnBackTimeTick--,t}GetCurrentTimeTick(){return BigInt((new Date).valueOf())-this.BaseTime}GetNextTimeTick(){let e=this.GetCurrentTimeTick();for(;e<=this._LastTimeTick;)e=this.GetCurrentTimeTick();return e}NextNumber(){if(this._IsOverCost){let e=this.NextOverCostId();if(e>=9007199254740992n)throw Error(`${e.toString()} over max of Number 9007199254740992`);return parseInt(e.toString())}{let e=this.NextNormalId();if(e>=9007199254740992n)throw Error(`${e.toString()} over max of Number 9007199254740992`);return parseInt(e.toString())}}NextId(){if(this._IsOverCost){let e=this.NextOverCostId();return e>=9007199254740992n?e:parseInt(e)}{let e=this.NextNormalId();return e>=9007199254740992n?e:parseInt(e)}}NextBigId(){return this._IsOverCost?this.NextOverCostId():this.NextNormalId()}}}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";i.r(n),i.d(n,{YeIMUniSDK:()=>J,YeIMUniSDKDefines:()=>e,instance:()=>$});var e={EVENT:{}};e.EVENT.NET_CHANGED="net_changed",e.EVENT.CONVERSATION_LIST_CHANGED="conversation_list_changed",e.EVENT.MESSAGE_RECEIVED="message_received",e.EVENT.KICKED_OUT="kicked_out",e.CONVERSATION_TYPE={},e.CONVERSATION_TYPE.PRIVATE="private",e.CONVERSATION_TYPE.GROUP="group",e.MESSAGE_TYPE={},e.MESSAGE_TYPE.TEXT="text",e.MESSAGE_TYPE.IMAGE="image",e.MESSAGE_TYPE.AUDIO="audio",e.MESSAGE_TYPE.VIDEO="video",e.MESSAGE_TYPE.LOCATION="location",e.MESSAGE_TYPE.CUSTOM="custom";var t=i(251),r=i.n(t);function o(e,t=null){return{code:500,message:e,data:t}}function s(e,t,i=null){try{null!=e&&void 0!==e.success&&"function"==typeof e.success&&e.success(function(e,t=null){return{code:200,message:e,data:t}}(t,i))}catch(e){console.error(e)}}function a(e,t,i=null){try{null!=e&&void 0!==e.fail&&"function"==typeof e.fail&&e.fail(o(t,i))}catch(e){console.error(e)}}function u(e,t){uni.$emit($.defaults.eventPrefix+e,t)}function c(e,t){e&&uni.$on($.defaults.eventPrefix+e,t)}function d(e,t){e&&uni.$off($.defaults.eventPrefix+e,t)}const l=function(e,t){if(0==$.defaults.logLevel)console.log("【YeIMUniSDK Log】",t);else{if(2==$.defaults.logLevel)return;1==e&&console.log("【YeIMUniSDK Log】",t)}};var h=function(e,t){return e<<t|e>>>32-t},f=function(e,t){var i,n,r,o,s;return r=2147483648&e,o=2147483648&t,s=(1073741823&e)+(1073741823&t),(i=1073741824&e)&(n=1073741824&t)?2147483648^s^r^o:i|n?1073741824&s?3221225472^s^r^o:1073741824^s^r^o:s^r^o},m=function(e,t,i,n,r,o,s){return e=f(e,f(f(function(e,t,i){return e&t|~e&i}(t,i,n),r),s)),f(h(e,o),t)},g=function(e,t,i,n,r,o,s){return e=f(e,f(f(function(e,t,i){return e&i|t&~i}(t,i,n),r),s)),f(h(e,o),t)},p=function(e,t,i,n,r,o,s){return e=f(e,f(f(function(e,t,i){return e^t^i}(t,i,n),r),s)),f(h(e,o),t)},T=function(e,t,i,n,r,o,s){return e=f(e,f(f(function(e,t,i){return t^(e|~i)}(t,i,n),r),s)),f(h(e,o),t)},y=function(e){var t,i="",n="";for(t=0;t<=3;t++)i+=(n="0"+(e>>>8*t&255).toString(16)).substr(n.length-2,2);return i};const I=function(e){e+="";var t,i,n,r,o,s,a,u,c,d=Array();for(e=function(e){e=e.replace(/\x0d\x0a/g,"\n");for(var t="",i=0;i<e.length;i++){var n=e.charCodeAt(i);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t}(e),d=function(e){for(var t,i=e.length,n=i+8,r=16*((n-n%64)/64+1),o=Array(r-1),s=0,a=0;a<i;)s=a%4*8,o[t=(a-a%4)/4]=o[t]|e.charCodeAt(a)<<s,a++;return s=a%4*8,o[t=(a-a%4)/4]=o[t]|128<<s,o[r-2]=i<<3,o[r-1]=i>>>29,o}(e),s=1732584193,a=4023233417,u=2562383102,c=271733878,t=0;t<d.length;t+=16)i=s,n=a,r=u,o=c,s=m(s,a,u,c,d[t+0],7,3614090360),c=m(c,s,a,u,d[t+1],12,3905402710),u=m(u,c,s,a,d[t+2],17,606105819),a=m(a,u,c,s,d[t+3],22,3250441966),s=m(s,a,u,c,d[t+4],7,4118548399),c=m(c,s,a,u,d[t+5],12,1200080426),u=m(u,c,s,a,d[t+6],17,2821735955),a=m(a,u,c,s,d[t+7],22,4249261313),s=m(s,a,u,c,d[t+8],7,1770035416),c=m(c,s,a,u,d[t+9],12,2336552879),u=m(u,c,s,a,d[t+10],17,4294925233),a=m(a,u,c,s,d[t+11],22,2304563134),s=m(s,a,u,c,d[t+12],7,1804603682),c=m(c,s,a,u,d[t+13],12,4254626195),u=m(u,c,s,a,d[t+14],17,2792965006),a=m(a,u,c,s,d[t+15],22,1236535329),s=g(s,a,u,c,d[t+1],5,4129170786),c=g(c,s,a,u,d[t+6],9,3225465664),u=g(u,c,s,a,d[t+11],14,643717713),a=g(a,u,c,s,d[t+0],20,3921069994),s=g(s,a,u,c,d[t+5],5,3593408605),c=g(c,s,a,u,d[t+10],9,38016083),u=g(u,c,s,a,d[t+15],14,3634488961),a=g(a,u,c,s,d[t+4],20,3889429448),s=g(s,a,u,c,d[t+9],5,568446438),c=g(c,s,a,u,d[t+14],9,3275163606),u=g(u,c,s,a,d[t+3],14,4107603335),a=g(a,u,c,s,d[t+8],20,1163531501),s=g(s,a,u,c,d[t+13],5,2850285829),c=g(c,s,a,u,d[t+2],9,4243563512),u=g(u,c,s,a,d[t+7],14,1735328473),a=g(a,u,c,s,d[t+12],20,2368359562),s=p(s,a,u,c,d[t+5],4,4294588738),c=p(c,s,a,u,d[t+8],11,2272392833),u=p(u,c,s,a,d[t+11],16,1839030562),a=p(a,u,c,s,d[t+14],23,4259657740),s=p(s,a,u,c,d[t+1],4,2763975236),c=p(c,s,a,u,d[t+4],11,1272893353),u=p(u,c,s,a,d[t+7],16,4139469664),a=p(a,u,c,s,d[t+10],23,3200236656),s=p(s,a,u,c,d[t+13],4,681279174),c=p(c,s,a,u,d[t+0],11,3936430074),u=p(u,c,s,a,d[t+3],16,3572445317),a=p(a,u,c,s,d[t+6],23,76029189),s=p(s,a,u,c,d[t+9],4,3654602809),c=p(c,s,a,u,d[t+12],11,3873151461),u=p(u,c,s,a,d[t+15],16,530742520),a=p(a,u,c,s,d[t+2],23,3299628645),s=T(s,a,u,c,d[t+0],6,4096336452),c=T(c,s,a,u,d[t+7],10,1126891415),u=T(u,c,s,a,d[t+14],15,2878612391),a=T(a,u,c,s,d[t+5],21,4237533241),s=T(s,a,u,c,d[t+12],6,1700485571),c=T(c,s,a,u,d[t+3],10,2399980690),u=T(u,c,s,a,d[t+10],15,4293915773),a=T(a,u,c,s,d[t+1],21,2240044497),s=T(s,a,u,c,d[t+8],6,1873313359),c=T(c,s,a,u,d[t+15],10,4264355552),u=T(u,c,s,a,d[t+6],15,2734768916),a=T(a,u,c,s,d[t+13],21,1309151649),s=T(s,a,u,c,d[t+4],6,4149444226),c=T(c,s,a,u,d[t+11],10,3174756917),u=T(u,c,s,a,d[t+2],15,718787259),a=T(a,u,c,s,d[t+9],21,3951481745),s=f(s,i),a=f(a,n),u=f(u,r),c=f(c,o);return(y(s)+y(a)+y(u)+y(c)).toLowerCase()};var v,k,S,_,b,E=E||function(e,t){var i={},n=i.lib={},r=function(){},o=n.Base={extend:function(e){r.prototype=this;var t=new r;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=n.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,i=e.words,n=this.sigBytes;if(e=e.sigBytes,this.clamp(),n%4)for(var r=0;r<e;r++)t[n+r>>>2]|=(i[r>>>2]>>>24-r%4*8&255)<<24-(n+r)%4*8;else if(65535<i.length)for(r=0;r<e;r+=4)t[n+r>>>2]=i[r>>>2];else t.push.apply(t,i);return this.sigBytes+=e,this},clamp:function(){var t=this.words,i=this.sigBytes;t[i>>>2]&=4294967295<<32-i%4*8,t.length=e.ceil(i/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var i=[],n=0;n<t;n+=4)i.push(4294967296*e.random()|0);return new s.init(i,t)}}),a=i.enc={},u=a.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var i=[],n=0;n<e;n++){var r=t[n>>>2]>>>24-n%4*8&255;i.push((r>>>4).toString(16)),i.push((15&r).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n+=2)i[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new s.init(i,t/2)}},c=a.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var i=[],n=0;n<e;n++)i.push(String.fromCharCode(t[n>>>2]>>>24-n%4*8&255));return i.join("")},parse:function(e){for(var t=e.length,i=[],n=0;n<t;n++)i[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(i,t)}},d=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},l=n.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var i=this._data,n=i.words,r=i.sigBytes,o=this.blockSize,a=r/(4*o);if(t=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,r=e.min(4*t,r),t){for(var u=0;u<t;u+=o)this._doProcessBlock(n,u);u=n.splice(0,t),i.sigBytes-=r}return new s.init(u,r)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=l.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,i){return new e.init(i).finalize(t)}},_createHmacHelper:function(e){return function(t,i){return new h.HMAC.init(e,i).finalize(t)}}});var h=i.algo={};return i}(Math);k=(b=(v=E).lib).WordArray,S=b.Hasher,_=[],b=v.algo.SHA1=S.extend({_doReset:function(){this._hash=new k.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var i=this._hash.words,n=i[0],r=i[1],o=i[2],s=i[3],a=i[4],u=0;80>u;u++){if(16>u)_[u]=0|e[t+u];else{var c=_[u-3]^_[u-8]^_[u-14]^_[u-16];_[u]=c<<1|c>>>31}c=(n<<5|n>>>27)+a+_[u],c=20>u?c+(1518500249+(r&o|~r&s)):40>u?c+(1859775393+(r^o^s)):60>u?c+((r&o|r&s|o&s)-1894007588):c+((r^o^s)-899497514),a=s,s=o,o=r<<30|r>>>2,r=n,n=c}i[0]=i[0]+n|0,i[1]=i[1]+r|0,i[2]=i[2]+o|0,i[3]=i[3]+s|0,i[4]=i[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,i=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(i/4294967296),t[15+(n+64>>>9<<4)]=i,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=S.clone.call(this);return e._hash=this._hash.clone(),e}}),v.SHA1=S._createHelper(b),v.HmacSHA1=S._createHmacHelper(b),function(){var e=E,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,i){e=this._hasher=new e.init,"string"==typeof i&&(i=t.parse(i));var n=e.blockSize,r=4*n;i.sigBytes>r&&(i=e.finalize(i)),i.clamp();for(var o=this._oKey=i.clone(),s=this._iKey=i.clone(),a=o.words,u=s.words,c=0;c<n;c++)a[c]^=1549556828,u[c]^=909522486;o.sigBytes=s.sigBytes=r,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}();const C=E;async function P(){let[e,t]=await uni.request({url:$.defaults.baseURL+"/upload/sign",data:{},method:"GET",header:{"content-type":"application/json",token:$.token}});if(t&&t.data&&t.data.data){let e=t.data.data;$.mediaUploadParams=e}else l(1,"媒体上传参数获取失败！")}async function N(e,t,i){let n=parseInt((new Date).getTime()/1e3)-1;(!$.mediaUploadParams||n>$.mediaUploadParams.expireTime)&&await P();let r=$.mediaUploadParams.nowTime,o=$.mediaUploadParams.expireTime,s=$.mediaUploadParams.secretId,a=r+";"+o,u=r+";"+o,c=$.mediaUploadParams.signKey,d=e+"\n"+t+"\n\n"+i+"\n",l="sha1\n"+u+"\n"+C.SHA1(d)+"\n";return"q-sign-algorithm=sha1&q-ak="+s+"&q-sign-time="+a+"&q-key-time="+u+"&q-header-list=&q-url-param-list=&q-signature="+C.HmacSHA1(l,c)}function M(e){if(!$.checkLogged())return a(e,"请登陆后再试");if(!$.mediaUploadParams)return l(1,"上传参数获取失败！");let t=$.mediaUploadParams,i=e.filename.substring(e.filename.lastIndexOf(".")),n=I((new Date).getTime()+"_"+e.filename)+"_image"+i,r="https://"+t.bucket+".cos."+t.region+".myqcloud.com",o=(t.customDomain?t.customDomain:r)+"/"+n;"cos"==t.storage&&setTimeout((async()=>{let t=await N("post","/",""),i=uni.uploadFile({url:r,name:"file",formData:{key:n,success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:t=>{s(e,"success",{url:o})},fail:t=>{a(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&i.onProgressUpdate((t=>{e.onProgress(t)}))}),0)}function B(e){if(!$.mediaUploadParams)return l(1,"媒体上传参数获取失败！");let t=$.mediaUploadParams,i=e.filename.substring(e.filename.lastIndexOf(".")),n=I((new Date).getTime()+"_"+e.filename)+"_image"+i,r="https://"+t.bucket+".cos."+t.region+".myqcloud.com",o=(t.customDomain?t.customDomain:r)+"/"+n;"cos"==t.storage&&setTimeout((async()=>{let t=await N("post","/",""),i=uni.uploadFile({url:r,name:"file",formData:{key:n,success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:t=>{s(e,"success",{url:o})},fail:t=>{a(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&i.onProgressUpdate((t=>{e.onProgress(t)}))}),0)}function O(){let e=Math.random(),t=1e7+Math.round(89999999*e);return(new Date).getTime()+"-"+$.genid.NextId()+"-"+t}const x=function(e){return{messageId:O(),conversationId:e.to,conversationType:e.conversationType,fromUserInfo:{nickname:$.user.nickname,avatarUrl:$.user.avatarUrl},from:$.userId,to:e.to,type:e.type,isRead:!1,isRecall:!1,status:"unSend",time:(new Date).getTime(),body:e.body}};function L(t){if(!$.userId)return o("请登陆后再调用此接口");if(null==t||!t.toId)return o("toId 不能为空");if(!t.conversationType)return o("conversationType 不能为空");if(!t.body||!t.body.text)return o("text 不能为空");let i={to:t.toId,type:e.MESSAGE_TYPE.TEXT,conversationType:t.conversationType,body:{text:t.body.text}};return x(i)}function U(t){if(!$.userId)return o("请登陆后再调用此接口");if(null==t||!t.toId)return o("toId 不能为空");if(!t.conversationType)return o("conversationType 不能为空");if(!t.body||!t.body.file)return o("file 不能为空");if(!t.body.file.tempFilePath)return o("tempFilePath 不能为空");if(!t.body.file.width)return o("width 不能为空");if(!t.body.file.height)return o("height 不能为空");let i={to:t.toId,type:e.MESSAGE_TYPE.IMAGE,conversationType:t.conversationType,body:{originalUrl:t.body.file.tempFilePath,originalWidth:t.body.file.width,originalHeight:t.body.file.height,thumbnailUrl:t.body.file.tempFilePath,thumbnailWidth:t.body.file.width,thumbnailHeight:t.body.file.height}},n=x(i);return void 0!==t.onProgress&&"function"==typeof t.onProgress&&(n.onProgress=t.onProgress),n}function A(t){if(!$.userId)return o("请登陆后再调用此接口");if(null==t||!t.toId)return o("toId 不能为空");if(!t.conversationType)return o("conversationType 不能为空");if(!t.body.address)return o("address 不能为空");if(!t.body.description)return o("description 不能为空");if(!t.body.longitude)return o("longitude 不能为空");if(!t.body.latitude)return o("latitude 不能为空");let i={to:t.toId,type:e.MESSAGE_TYPE.LOCATION,conversationType:t.conversationType,body:{address:t.body.address,description:t.body.description,longitude:t.body.longitude,latitude:t.body.latitude}};return x(i)}function w(t){if(!$.userId)return o("请登陆后再调用此接口");if(null==t||!t.toId)return o("toId 不能为空");if(!t.conversationType)return o("conversationType 不能为空");if(!t.body||!t.body.file)return o("file 不能为空");if(!t.body.file.tempFilePath)return o("tempFilePath 不能为空");if(!t.body.file.duration)return o("duration 不能为空");let i={to:t.toId,type:e.MESSAGE_TYPE.AUDIO,conversationType:t.conversationType,body:{audioUrl:t.body.file.tempFilePath,duration:t.body.file.duration}},n=x(i);return void 0!==t.onProgress&&"function"==typeof t.onProgress&&(n.onProgress=t.onProgress),n}function q(t){if(!$.userId)return o("请登陆后再调用此接口");if(null==t||!t.toId)return o("toId 不能为空");if(!t.conversationType)return o("conversationType 不能为空");if(!t.body||!t.body.file)return o("file 不能为空");if(!t.body.file.tempFilePath)return o("tempFilePath 不能为空");if(!t.body.file.width)return o("width 不能为空");if(!t.body.file.height)return o("height 不能为空");let i={to:t.toId,type:e.MESSAGE_TYPE.VIDEO,conversationType:t.conversationType,body:{videoUrl:t.body.file.tempFilePath,thumbnailUrl:null,videoWidth:t.body.file.width,videoHeight:t.body.file.height}},n=x(i);return void 0!==t.onProgress&&"function"==typeof t.onProgress&&(n.onProgress=t.onProgress),n}function D(t){if(!$.userId)return o("请登陆后再试");if(null==t||!t.toId)return o("toId 不能为空");if(!t.conversationType)return o("conversationType 不能为空");if(!t.body)return o("自定义消息的 body 不能为空");let i={to:t.toId,type:e.MESSAGE_TYPE.CUSTOM,conversationType:t.conversationType,body:t.body};return x(i)}function G(t){if(!$.checkLogged())return a(t,"请登陆后再试");if(!t.message)return a(t,"message 不能为空");let i=t.message;i.type==e.MESSAGE_TYPE.TEXT?H(t):i.type==e.MESSAGE_TYPE.IMAGE?function(e){let t=e.message;B({filename:$.token+"_image.png",filepath:t.body.originalUrl,success:i=>{let n=i.data.url;if(t.body.originalUrl=n,t.body.originalHeight>198){let e=198/t.body.originalHeight;t.body.thumbnailHeight=parseInt(t.body.originalHeight*e),t.body.thumbnailWidth=parseInt(t.body.originalWidth*e),t.body.thumbnailUrl=t.body.originalUrl+"?imageMogr2/thumbnail/"+t.body.thumbnailWidth+"x"+t.body.thumbnailHeight}e.message=t,H(e)},fail:e=>{l(1,e)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(t):i.type==e.MESSAGE_TYPE.VIDEO?function(e){let t=e.message;!function(e){if(!$.mediaUploadParams)return l(1,"媒体上传参数获取失败！");let t=$.mediaUploadParams,i=e.filename.substring(e.filename.lastIndexOf(".")),n=I((new Date).getTime()+"_"+e.filename)+"_video"+i,r="https://"+t.bucket+".cos."+t.region+".myqcloud.com",o=(t.customDomain?t.customDomain:r)+"/"+n;"cos"==t.storage&&setTimeout((async()=>{let t=await N("post","/",""),i=uni.uploadFile({url:r,name:"file",formData:{key:n,success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:async()=>{let t=await N("get","/"+n,"");uni.downloadFile({url:r+"/"+n+"?ci-process=snapshot&time=1",header:{Authorization:t},success:t=>{200===t.statusCode?B({filename:I(n+t.tempFilePath)+"_videoThumb.jpg",filepath:t.tempFilePath,success:t=>{s(e,"success",{videoUrl:o,thumbnailUrl:t.data.url})},fail:t=>{a(e,t)}}):a(e,"腾讯云媒体截图接口：下载视频缩略图失败")},fail:t=>{a(e,"腾讯云媒体截图接口：下载视频缩略图失败")}})},fail:t=>{a(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&i.onProgressUpdate((t=>{e.onProgress(t)}))}),0)}({filename:$.token+"_video.mp4",filepath:t.body.videoUrl,success:i=>{let n=i.data.videoUrl,r=i.data.thumbnailUrl;t.body.videoUrl=n,t.body.thumbnailUrl=r,e.message=t,H(e)},fail:e=>{l(1,e)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(t):i.type==e.MESSAGE_TYPE.AUDIO?function(e){let t=e.message;!function(e){if(!$.mediaUploadParams)return l(1,"媒体上传参数获取失败！");let t=$.mediaUploadParams,i=e.filename.substring(e.filename.lastIndexOf(".")),n=I((new Date).getTime()+"_"+e.filename)+"_audio"+i,r="https://"+t.bucket+".cos."+t.region+".myqcloud.com",o=(t.customDomain?t.customDomain:r)+"/"+n;"cos"==t.storage&&setTimeout((async()=>{let t=await N("post","/",""),i=uni.uploadFile({url:r,name:"file",formData:{key:n,success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:t=>{s(e,"success",{url:o})},fail:t=>{a(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&i.onProgressUpdate((t=>{e.onProgress(t)}))}),0)}({filename:$.token+"_audio.aac",filepath:t.body.audioUrl,success:i=>{let n=i.data.url;t.body.audioUrl=n,e.message=t,H(e)},fail:e=>{l(1,e)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(t):i.type==e.MESSAGE_TYPE.LOCATION&&H(t)}function H(e){let t=e.message;uni.request({url:$.defaults.baseURL+"/message/save",data:t,method:"POST",header:{"content-type":"application/json",token:$.token},success:t=>{let i=t.data.data;R(i),s(e,"接口调用成功",i)},fail:t=>{a(e,t)}})}function R(e){let t=V(e.conversationId);if(-1===t.findIndex((t=>t.messageId===e.messageId))){t.push(e);let i="yeim:messageList:"+I($.userId)+":conversationId:"+I(e.conversationId);uni.setStorageSync(i,t)}}function Y(e){if(!$.checkLogged())return a(e,"请登陆后再试");if(!e.conversationId)return a(e,"conversationId 不能为空");if(e.page&&parseFloat(e.page)||(e.page=1),1!=e.page)return F(e,e.page);let t=V(e.conversationId);if(t.length<=0)F(e,e.page);else{let i="yeim:conversationList:"+I($.userId),n=uni.getStorageSync(i);if(n=n||[],n<=0)return a(e,"会话不存在");{let i=n.findIndex((t=>t.conversationId===e.conversationId));if(-1===i)return a({code:500,message:"会话不存在"},e);if(n[i].lastMessage.messageId==t[t.length-1].messageId)return s(e,"接口调用成功",t);F(e,e.page)}}}function V(e){let t="yeim:messageList:"+I($.userId)+":conversationId:"+I(e),i=uni.getStorageSync(t);return i=i||[],i.sort(((e,t)=>e.sequence-t.sequence)),i}function F(e,t=1){uni.request({url:$.defaults.baseURL+"/message/list",data:{page:t,conversationId:e.conversationId},method:"GET",header:{"content-type":"application/json",token:$.token},success:i=>{let n=i.data.data.records;if(n=n.reverse(),n.sort(((e,t)=>e.sequence-t.sequence)),s(e,"接口调用成功",n),1==t){let t="yeim:messageList:"+I($.userId)+":conversationId:"+I(e.conversationId);uni.setStorageSync(t,n)}},fail:t=>{a(e,t),l(1,t)}})}function W(e=1,t=20){let i="yeim:conversationList:"+I($.userId),n=uni.getStorageSync(i);n=n||[];let r=(e-1)*t;return r+t>=n.length?n.slice(r,n.length):n.slice(r,r+t)}function z(t){let i="yeim:conversationList:"+I($.userId);uni.setStorageSync(i,t),u(e.EVENT.CONVERSATION_LIST_CHANGED,t)}function j(e){return $.checkLogged()?e.userId?void uni.request({url:$.defaults.baseURL+"/user/info",data:{userId:e.userId},method:"GET",header:{token:$.token},success:t=>{s(e,"接口调用成功",t.data.data)},fail:t=>{a(e,t),log(1,t)}}):a(e,"userId 不能为空"):a(e,"请登陆后再试")}function K(e){return $.checkLogged()?e.nickname?e.avatarUrl?void uni.request({url:$.defaults.baseURL+"/user/update",data:{nickname:e.nickname,avatarUrl:e.avatarUrl},method:"POST",header:{"content-type":"application/json",token:$.token},success:t=>{s(e,"接口调用成功")},fail:t=>{a(e,t),log(1,t)}}):a(e,"avatarUrl 不能为空"):a(e,"nickname 不能为空"):a(e,"请登陆后再试")}let $;class J{constructor(e={}){this.defaults={eventPrefix:"YeIM_",reConnectTotal:15,reConnectInterval:3e3,heartInterval:3e4,logLevel:0,...e},this.firstConnect=!0,this.socketTask=void 0,this.socketLogged=!1,this.allowReconnect=!0,this.lockReconnect=!1,this.reConnectNum=0,this.heartTimer=null,this.checkTimer=null,this.genid=new(r())({WorkerId:1}),this.user={},this.userId=void 0,this.token=void 0,this.mediaUploadParams={}}static init(e={}){return $||($=new J(e),J.prototype.createTextMessage=L,J.prototype.createImageMessage=U,J.prototype.createAudioMessage=w,J.prototype.createVideoMessage=q,J.prototype.createLocationMessage=A,J.prototype.createCustomMessage=D,J.prototype.upload=M,J.prototype.sendMessage=G,J.prototype.getMessageList=Y,J.prototype.getConversationList=W,J.prototype.getUserInfo=j,J.prototype.updateUserInfo=K,J.prototype.addEventListener=c,J.prototype.removeEventListener=d,console.log("============= YeIMUniSDK 初始化成功！============="),$)}static getInstance(){return $||null}connect(e={}){if(!e.userId)return a(e,"userId 不能为空");if(!e.token)return a(e,"token 不能为空");this.firstConnect&&(uni.onSocketOpen(this.socketOpen.bind(this)),uni.onSocketError(this.socketError.bind(this)),uni.onSocketClose(this.socketClose.bind(this)),uni.onSocketMessage(this.socketMessage.bind(this)));let t=this.defaults.socketURL+"/"+e.userId+"/"+e.token;this.socketTask=uni.connectSocket({url:t,success:e=>{console.log(e)},fail:e=>{console.log(e)},complete:()=>{}}),this.firstConnect=!1;let i=setTimeout((()=>(i=void 0,l(1,"连接服务端失败，请检查配置"),a(e,"网络异常，请稍后重试"))),5e3);this.socketTask.onMessage((t=>{if(!i)return;clearTimeout(i),i=void 0;let n=JSON.parse(t.data);return 201==n.code?(this.socketTask.onMessage((()=>{})),this.user=n.data,this.userId=e.userId,this.token=e.token,this.socketLogged=!0,l(1,"IMServer登陆成功，登陆用户："+e.userId),function(e=1,t=20){uni.request({url:$.defaults.baseURL+"/conversation/list",data:{page:e,limit:t},method:"GET",header:{"content-type":"application/json",token:$.token},success:e=>{z(e.data.data.records)},fail:e=>{l(1,e)}})}(1,1e5),P(),s(e,"登陆成功",n.data)):a(e,n.message)}))}reConnect(){if(this.allowReconnect&&!this.lockReconnect){if(!this.userId||!this.token)return void(this.allowReconnect=!1);if(this.defaults.reConnectTotal>0&&this.defaults.reConnectTotal<=this.reConnectNum)return void(this.allowReconnect=!1);this.reConnectNum++,this.lockReconnect=!0,u(e.EVENT.NET_CHANGED,"connecting"),setTimeout((()=>{l(1,"IMSDK 正在第"+this.reConnectNum+"次重连"),this.connect({userId:this.userId,token:this.token}),this.lockReconnect=!1}),this.defaults.reConnectInterval)}}readyState(){return this.socketTask?this.socketTask.readyState:3}startHeartTimer(){this.clearHeartTimer(),this.heartTimer=setTimeout((()=>{if(1==this.readyState()){let e={type:"heart",data:"ping"};uni.sendSocketMessage({data:JSON.stringify(e)}),this.checkTimer=setTimeout((()=>{uni.closeSocket()}),this.defaults.heartInterval)}}),this.defaults.heartInterval)}clearHeartTimer(){return clearTimeout(this.heartTimer),clearTimeout(this.checkTimer),this}socketOpen(t){console.log(t),u(e.EVENT.NET_CHANGED,"connected")}socketClose(t){console.log(t),this.socketLogged=!1,u(e.EVENT.NET_CHANGED,"closed"),this.reConnect()}socketError(e){console.log(e),this.reConnect()}socketMessage(e){if(l(0,e),this.startHeartTimer(),!this.socketLogged)return;let t=JSON.parse(e.data);t?this.socketMessageHandle(t):l(1,e)}socketMessageHandle(t){if(200==t.code){let i=t.data;R(i),u(e.EVENT.MESSAGE_RECEIVED,i),this.notifySocketMessageReceived(i)}else 203==t.code?function(e){let t=W(1,1e5),i=t.findIndex((t=>t.conversationId===e.conversationId));-1===i||t.splice(i,1),t.unshift(e),z(t)}(t.data):109==t.code&&(this.allowReconnect=!1,u(e.EVENT.KICKED_OUT,!0),l(1,"用户："+this.userId+"，被踢下线了"))}notifySocketMessageReceived(e){let t={type:"received_call",data:e};uni.sendSocketMessage({data:JSON.stringify(t),fail:e=>{l(1,e)}})}checkLogged(){return!!(this.socketLogged&&this.userId&&this.token)||(l(1,"请登陆后再调用此方法"),!1)}}})(),n})()));