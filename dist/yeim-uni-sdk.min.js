!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(self,(()=>(()=>{var e={251:e=>{e.exports=class{constructor(e){if(void 0===e.WorkerId)throw new Error("lost WorkerId");(!e.BaseTime||e.BaseTime<0)&&(e.BaseTime=1667232e6),(!e.WorkerIdBitLength||e.WorkerIdBitLength<0)&&(e.WorkerIdBitLength=6),(!e.SeqBitLength||e.SeqBitLength<0)&&(e.SeqBitLength=6),(e.MaxSeqNumber<=0||void 0===e.MaxSeqNumber)&&(e.MaxSeqNumber=63),(!e.MinSeqNumber||e.MinSeqNumber<0)&&(e.MinSeqNumber=5),(!e.TopOverCostCount||e.TopOverCostCount<0)&&(e.TopOverCostCount=2e3),2!==e.Method?e.Method=1:e.Method=2,this.Method=BigInt(e.Method),this.BaseTime=BigInt(e.BaseTime),this.WorkerId=BigInt(e.WorkerId),this.WorkerIdBitLength=BigInt(e.WorkerIdBitLength),this.SeqBitLength=BigInt(e.SeqBitLength),this.MaxSeqNumber=BigInt(e.MaxSeqNumber),this.MinSeqNumber=BigInt(e.MinSeqNumber),this.TopOverCostCount=BigInt(e.TopOverCostCount);const t=this.WorkerIdBitLength+this.SeqBitLength,n=this.MinSeqNumber;this._TimestampShift=t,this._CurrentSeqNumber=n,this._LastTimeTick=0,this._TurnBackTimeTick=0,this._TurnBackIndex=0,this._IsOverCost=!1,this._OverCostCountInOneTerm=0}DoGenIdAction(e){}BeginOverCostAction(e){}EndOverCostAction(e){}BeginTurnBackAction(e){}EndTurnBackAction(e){}NextOverCostId(){const e=this.GetCurrentTimeTick();return e>this._LastTimeTick?(this._LastTimeTick=e,this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!1,this._OverCostCountInOneTerm=0,this.CalcId(this._LastTimeTick)):this._OverCostCountInOneTerm>=this.TopOverCostCount?(this._LastTimeTick=this.GetNextTimeTick(),this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!1,this._OverCostCountInOneTerm=0,this.CalcId(this._LastTimeTick)):this._CurrentSeqNumber>this.MaxSeqNumber?(this._LastTimeTick++,this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!0,this._OverCostCountInOneTerm++,this.CalcId(this._LastTimeTick)):this.CalcId(this._LastTimeTick)}NextNormalId(){const e=this.GetCurrentTimeTick();return e<this._LastTimeTick?(this._TurnBackTimeTick<1&&(this._TurnBackTimeTick=this._LastTimeTick-1,this._TurnBackIndex++,this._TurnBackIndex>4&&(this._TurnBackIndex=1),this.BeginTurnBackAction(this._TurnBackTimeTick)),this.CalcTurnBackId(this._TurnBackTimeTick)):(this._TurnBackTimeTick>0&&(this.EndTurnBackAction(this._TurnBackTimeTick),this._TurnBackTimeTick=0),e>this._LastTimeTick?(this._LastTimeTick=e,this._CurrentSeqNumber=this.MinSeqNumber,this.CalcId(this._LastTimeTick)):this._CurrentSeqNumber>this.MaxSeqNumber?(this.BeginOverCostAction(e),this._LastTimeTick++,this._CurrentSeqNumber=this.MinSeqNumber,this._IsOverCost=!0,this._OverCostCountInOneTerm=1,this.CalcId(this._LastTimeTick)):this.CalcId(this._LastTimeTick))}CalcId(e){const t=BigInt(e<<this._TimestampShift)+BigInt(this.WorkerId<<this.SeqBitLength)+BigInt(this._CurrentSeqNumber);return this._CurrentSeqNumber++,t}CalcTurnBackId(e){const t=BigInt(e<<this._TimestampShift)+BigInt(this.WorkerId<<this.SeqBitLength)+BigInt(this._TurnBackIndex);return this._TurnBackTimeTick--,t}GetCurrentTimeTick(){return BigInt((new Date).valueOf())-this.BaseTime}GetNextTimeTick(){let e=this.GetCurrentTimeTick();for(;e<=this._LastTimeTick;)e=this.GetCurrentTimeTick();return e}NextNumber(){if(this._IsOverCost){let e=this.NextOverCostId();if(e>=9007199254740992n)throw Error(`${e.toString()} over max of Number 9007199254740992`);return parseInt(e.toString())}{let e=this.NextNormalId();if(e>=9007199254740992n)throw Error(`${e.toString()} over max of Number 9007199254740992`);return parseInt(e.toString())}}NextId(){if(this._IsOverCost){let e=this.NextOverCostId();return e>=9007199254740992n?e:parseInt(e)}{let e=this.NextNormalId();return e>=9007199254740992n?e:parseInt(e)}}NextBigId(){return this._IsOverCost?this.NextOverCostId():this.NextNormalId()}}}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{"use strict";n.r(i),n.d(i,{YeIMUniSDK:()=>q,YeIMUniSDKDefines:()=>e,instance:()=>x});var e={EVENT:{}};e.EVENT.NET_CHANGED="net_changed",e.EVENT.CONVERSATION_LIST_CHANGED="conversation_list_changed",e.EVENT.MESSAGE_RECEIVED="message_received",e.EVENT.KICKED_OUT="kicked_out",e.CONVERSATION_TYPE={},e.CONVERSATION_TYPE.PRIVATE="private",e.CONVERSATION_TYPE.GROUP="group",e.MESSAGE_TYPE={},e.MESSAGE_TYPE.TEXT="text",e.MESSAGE_TYPE.CUSTOM="custom";var t=n(251),r=n.n(t);function s(e,t=null){return{code:500,message:e,data:t}}function o(e,t,n=null){try{null!=e&&void 0!==e.success&&"function"==typeof e.success&&e.success(function(e,t=null){return{code:200,message:e,data:t}}(t,n))}catch(e){console.error(e)}}function a(e,t,n=null){try{null!=e&&void 0!==e.fail&&"function"==typeof e.fail&&e.fail(s(t,n))}catch(e){console.error(e)}}function c(e,t){uni.$emit(x.defaults.eventPrefix+e,t)}function u(e,t){e&&uni.$on(x.defaults.eventPrefix+e,t)}function d(e,t){e&&uni.$off(x.defaults.eventPrefix+e,t)}const h=function(e,t){if(0==x.defaults.logLevel)console.log("【YeIMUniSDK Log】",t);else{if(2==x.defaults.logLevel)return;1==e&&console.log("【YeIMUniSDK Log】",t)}};var l=function(e,t){return e<<t|e>>>32-t},T=function(e,t){var n,i,r,s,o;return r=2147483648&e,s=2147483648&t,o=(1073741823&e)+(1073741823&t),(n=1073741824&e)&(i=1073741824&t)?2147483648^o^r^s:n|i?1073741824&o?3221225472^o^r^s:1073741824^o^r^s:o^r^s},m=function(e,t,n,i,r,s,o){return e=T(e,T(T(function(e,t,n){return e&t|~e&n}(t,n,i),r),o)),T(l(e,s),t)},f=function(e,t,n,i,r,s,o){return e=T(e,T(T(function(e,t,n){return e&n|t&~n}(t,n,i),r),o)),T(l(e,s),t)},g=function(e,t,n,i,r,s,o){return e=T(e,T(T(function(e,t,n){return e^t^n}(t,n,i),r),o)),T(l(e,s),t)},I=function(e,t,n,i,r,s,o){return e=T(e,T(T(function(e,t,n){return t^(e|~n)}(t,n,i),r),o)),T(l(e,s),t)},k=function(e){var t,n="",i="";for(t=0;t<=3;t++)n+=(i="0"+(e>>>8*t&255).toString(16)).substr(i.length-2,2);return n};const v=function(e){e+="";var t,n,i,r,s,o,a,c,u,d=Array();for(e=function(e){e=e.replace(/\x0d\x0a/g,"\n");for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n);i<128?t+=String.fromCharCode(i):i>127&&i<2048?(t+=String.fromCharCode(i>>6|192),t+=String.fromCharCode(63&i|128)):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128),t+=String.fromCharCode(63&i|128))}return t}(e),d=function(e){for(var t,n=e.length,i=n+8,r=16*((i-i%64)/64+1),s=Array(r-1),o=0,a=0;a<n;)o=a%4*8,s[t=(a-a%4)/4]=s[t]|e.charCodeAt(a)<<o,a++;return o=a%4*8,s[t=(a-a%4)/4]=s[t]|128<<o,s[r-2]=n<<3,s[r-1]=n>>>29,s}(e),o=1732584193,a=4023233417,c=2562383102,u=271733878,t=0;t<d.length;t+=16)n=o,i=a,r=c,s=u,o=m(o,a,c,u,d[t+0],7,3614090360),u=m(u,o,a,c,d[t+1],12,3905402710),c=m(c,u,o,a,d[t+2],17,606105819),a=m(a,c,u,o,d[t+3],22,3250441966),o=m(o,a,c,u,d[t+4],7,4118548399),u=m(u,o,a,c,d[t+5],12,1200080426),c=m(c,u,o,a,d[t+6],17,2821735955),a=m(a,c,u,o,d[t+7],22,4249261313),o=m(o,a,c,u,d[t+8],7,1770035416),u=m(u,o,a,c,d[t+9],12,2336552879),c=m(c,u,o,a,d[t+10],17,4294925233),a=m(a,c,u,o,d[t+11],22,2304563134),o=m(o,a,c,u,d[t+12],7,1804603682),u=m(u,o,a,c,d[t+13],12,4254626195),c=m(c,u,o,a,d[t+14],17,2792965006),a=m(a,c,u,o,d[t+15],22,1236535329),o=f(o,a,c,u,d[t+1],5,4129170786),u=f(u,o,a,c,d[t+6],9,3225465664),c=f(c,u,o,a,d[t+11],14,643717713),a=f(a,c,u,o,d[t+0],20,3921069994),o=f(o,a,c,u,d[t+5],5,3593408605),u=f(u,o,a,c,d[t+10],9,38016083),c=f(c,u,o,a,d[t+15],14,3634488961),a=f(a,c,u,o,d[t+4],20,3889429448),o=f(o,a,c,u,d[t+9],5,568446438),u=f(u,o,a,c,d[t+14],9,3275163606),c=f(c,u,o,a,d[t+3],14,4107603335),a=f(a,c,u,o,d[t+8],20,1163531501),o=f(o,a,c,u,d[t+13],5,2850285829),u=f(u,o,a,c,d[t+2],9,4243563512),c=f(c,u,o,a,d[t+7],14,1735328473),a=f(a,c,u,o,d[t+12],20,2368359562),o=g(o,a,c,u,d[t+5],4,4294588738),u=g(u,o,a,c,d[t+8],11,2272392833),c=g(c,u,o,a,d[t+11],16,1839030562),a=g(a,c,u,o,d[t+14],23,4259657740),o=g(o,a,c,u,d[t+1],4,2763975236),u=g(u,o,a,c,d[t+4],11,1272893353),c=g(c,u,o,a,d[t+7],16,4139469664),a=g(a,c,u,o,d[t+10],23,3200236656),o=g(o,a,c,u,d[t+13],4,681279174),u=g(u,o,a,c,d[t+0],11,3936430074),c=g(c,u,o,a,d[t+3],16,3572445317),a=g(a,c,u,o,d[t+6],23,76029189),o=g(o,a,c,u,d[t+9],4,3654602809),u=g(u,o,a,c,d[t+12],11,3873151461),c=g(c,u,o,a,d[t+15],16,530742520),a=g(a,c,u,o,d[t+2],23,3299628645),o=I(o,a,c,u,d[t+0],6,4096336452),u=I(u,o,a,c,d[t+7],10,1126891415),c=I(c,u,o,a,d[t+14],15,2878612391),a=I(a,c,u,o,d[t+5],21,4237533241),o=I(o,a,c,u,d[t+12],6,1700485571),u=I(u,o,a,c,d[t+3],10,2399980690),c=I(c,u,o,a,d[t+10],15,4293915773),a=I(a,c,u,o,d[t+1],21,2240044497),o=I(o,a,c,u,d[t+8],6,1873313359),u=I(u,o,a,c,d[t+15],10,4264355552),c=I(c,u,o,a,d[t+6],15,2734768916),a=I(a,c,u,o,d[t+13],21,1309151649),o=I(o,a,c,u,d[t+4],6,4149444226),u=I(u,o,a,c,d[t+11],10,3174756917),c=I(c,u,o,a,d[t+2],15,718787259),a=I(a,c,u,o,d[t+9],21,3951481745),o=T(o,n),a=T(a,i),c=T(c,r),u=T(u,s);return(k(o)+k(a)+k(c)+k(u)).toLowerCase()};function S(){let e=Math.random(),t=1e7+Math.round(89999999*e);return(new Date).getTime()+"-"+x.genid.NextId()+"-"+t}const C=function(e){return{messageId:S(),conversationId:e.to,conversationType:e.conversationType,fromUserInfo:{nickname:x.user.nickname,avatarUrl:x.user.avatarUrl},from:x.userId,to:e.to,type:e.type,isRead:!1,isRecall:!1,status:"unSend",time:(new Date).getTime(),body:e.body}};function p(t){if(!x.userId)return s("请登陆后再调用此接口");if(null==t||!t.toId)return s("toId 不能为空");if(!t.conversationType)return s("conversationType 不能为空");if(!t.body||!t.body.text)return s("text 不能为空");let n={to:t.toId,type:e.MESSAGE_TYPE.TEXT,conversationType:t.conversationType,body:{text:t.body.text}};return C(n)}function _(t){if(!x.userId)return s("请登陆后再试");if(null==t||!t.toId)return s("toId 不能为空");if(!t.conversationType)return s("conversationType 不能为空");if(!t.body)return s("自定义消息的 body 不能为空");let n={to:t.toId,type:e.MESSAGE_TYPE.CUSTOM,conversationType:t.conversationType,body:t.body};return C(n)}function N(t){return x.checkLogged()?t.message?void(t.message.type==e.MESSAGE_TYPE.TEXT&&function(e){let t=e.message;uni.request({url:x.defaults.baseURL+"/message/save",data:t,method:"POST",header:{"content-type":"application/json",token:x.token},success:t=>{let n=t.data.data;E(n),o(e,"接口调用成功",n)},fail:t=>{a(e,t)}})}(t)):a(t,"message 不能为空"):a(t,"请登陆后再试")}function E(e){let t=L(e.conversationId);if(-1===t.findIndex((t=>t.messageId===e.messageId))){t.push(e);let n="yeim:messageList:"+v(x.userId)+":conversationId:"+v(e.conversationId);uni.setStorageSync(n,t)}}function y(e){if(!x.checkLogged())return a(e,"请登陆后再试");if(!e.conversationId)return a(e,"conversationId 不能为空");if(e.page&&parseFloat(e.page)||(e.page=1),1!=e.page)return O(e,e.page);let t=L(e.conversationId);if(t.length<=0)O(e,e.page);else{let n="yeim:conversationList:"+v(x.userId),i=uni.getStorageSync(n);if(i=i||[],i<=0)return a(e,"会话不存在");{let n=i.findIndex((t=>t.conversationId===e.conversationId));if(-1===n)return a({code:500,message:"会话不存在"},e);if(i[n].lastMessage.messageId==t[t.length-1].messageId)return o(e,"接口调用成功",t);O(e,e.page)}}}function L(e){let t="yeim:messageList:"+v(x.userId)+":conversationId:"+v(e),n=uni.getStorageSync(t);return n=n||[],n}function O(e,t=1){uni.request({url:x.defaults.baseURL+"/message/list",data:{page:t,conversationId:e.conversationId},method:"GET",header:{"content-type":"application/json",token:x.token},success:n=>{console.log(n);let i=n.data.data.records;if(i=i.reverse(),o(e,"接口调用成功",i),1==t){let t="yeim:messageList:"+v(x.userId)+":conversationId:"+v(e.conversationId);uni.setStorageSync(t,i)}},fail:t=>{a(e,t),log(1,t)}})}function M(e=1,t=20){let n="yeim:conversationList:"+v(x.userId),i=uni.getStorageSync(n);i=i||[];let r=(e-1)*t;return r+t>=i.length?i.slice(r,i.length):i.slice(r,r+t)}function b(t){let n="yeim:conversationList:"+v(x.userId);uni.setStorageSync(n,t),c(e.EVENT.CONVERSATION_LIST_CHANGED,t)}function B(e){return e.nickname?e.avatarUrl?void uni.request({url:x.defaults.baseURL+"/user/update",data:{nickname:e.nickname,avatarUrl:e.avatarUrl},method:"POST",header:{"content-type":"application/json",token:x.token},success:t=>{o(e,"接口调用成功")},fail:t=>{a(e,t),log(1,t)}}):a(e,"avatarUrl 不能为空"):a(e,"nickname 不能为空")}let x;class q{constructor(e={}){this.defaults={eventPrefix:"YeIM_",reConnectTotal:15,reConnectInterval:3e3,heartInterval:3e4,logLevel:0,...e},this.firstConnect=!0,this.socketTask=void 0,this.socketLogged=!1,this.allowReconnect=!0,this.lockReconnect=!1,this.reConnectNum=0,this.heartTimer=null,this.checkTimer=null,this.genid=new(r())({WorkerId:1}),this.user={},this.userId=void 0,this.token=void 0}static init(e={}){return x||(x=new q(e),q.prototype.createTextMessage=p,q.prototype.createCustomMessage=_,q.prototype.sendMessage=N,q.prototype.getMessageList=y,q.prototype.getConversationList=M,q.prototype.updateUserInfo=B,q.prototype.addEventListener=u,q.prototype.removeEventListener=d,console.log("============= YeIMUniSDK 初始化成功！============="),x)}static getInstance(){return x||null}connect(e={}){if(!e.userId)return a(e,"userId 不能为空");if(!e.token)return a(e,"token 不能为空");this.firstConnect&&(uni.onSocketOpen(this.socketOpen.bind(this)),uni.onSocketError(this.socketError.bind(this)),uni.onSocketClose(this.socketClose.bind(this)),uni.onSocketMessage(this.socketMessage.bind(this)));let t=this.defaults.socketURL+"/"+e.userId+"/"+e.token;this.socketTask=uni.connectSocket({url:t,success:e=>{console.log(e)},fail:e=>{console.log(e)},complete:()=>{}}),this.firstConnect=!1;let n=setTimeout((()=>(n=void 0,h(1,"连接服务端失败，请检查配置"),a(e,"网络异常，请稍后重试"))),5e3);this.socketTask.onMessage((t=>{if(!n)return;clearTimeout(n),n=void 0;let i=JSON.parse(t.data);return 201==i.code?(this.socketTask.onMessage((()=>{})),this.user=i.data,this.userId=e.userId,this.token=e.token,this.socketLogged=!0,h(1,"IMServer登陆成功，登陆用户："+e.userId),function(e=1,t=20){uni.request({url:x.defaults.baseURL+"/conversation/list",data:{page:e,limit:t},method:"GET",header:{"content-type":"application/json",token:x.token},success:e=>{b(e.data.data.records)},fail:e=>{h(1,e)}})}(1,1e5),o(e,"登陆成功",i.data)):a(e,i.message)}))}reConnect(){if(this.allowReconnect&&!this.lockReconnect){if(!this.userId||!this.token)return void(this.allowReconnect=!1);if(this.defaults.reConnectTotal>0&&this.defaults.reConnectTotal<=this.reConnectNum)return void(this.allowReconnect=!1);this.reConnectNum++,this.lockReconnect=!0,c(e.EVENT.NET_CHANGED,"connecting"),setTimeout((()=>{h(1,"IMSDK 正在第"+this.reConnectNum+"次重连"),this.connect({userId:this.userId,token:this.token}),this.lockReconnect=!1}),this.defaults.reConnectInterval)}}readyState(){return this.socketTask?this.socketTask.readyState:0}startHeartTimer(){this.clearHeartTimer(),this.heartTimer=setTimeout((()=>{if(1==this.readyState()){let e={type:"heart",data:"ping"};uni.sendSocketMessage({data:JSON.stringify(e)}),this.checkTimer=setTimeout((()=>{uni.closeSocket()}),this.defaults.heartInterval)}}),this.defaults.heartInterval)}clearHeartTimer(){return clearTimeout(this.heartTimer),clearTimeout(this.checkTimer),this}socketOpen(t){console.log(t),c(e.EVENT.NET_CHANGED,"connected")}socketClose(t){console.log(t),this.socketLogged=!1,c(e.EVENT.NET_CHANGED,"closed"),this.reConnect()}socketError(e){console.log(e),this.reConnect()}socketMessage(e){if(h(0,e),this.startHeartTimer(),!this.socketLogged)return;let t=JSON.parse(e.data);t?this.socketMessageHandle(t):h(1,e)}socketMessageHandle(t){if(200==t.code){let n=t.data;E(n),c(e.EVENT.MESSAGE_RECEIVED,n),this.notifySocketMessageReceived(n)}else 203==t.code?function(e){let t=M(1,1e5),n=t.findIndex((t=>t.conversationId===e.conversationId));-1===n||t.splice(n,1),t.unshift(e),b(t)}(t.data):109==t.code&&(this.allowReconnect=!1,c(e.EVENT.KICKED_OUT,!0),h(1,"用户："+this.userId+"，被踢下线了"))}notifySocketMessageReceived(e){let t={type:"received_call",data:e};uni.sendSocketMessage({data:JSON.stringify(t),fail:e=>{h(1,e)}})}checkLogged(){return!!(this.socketLogged&&this.userId&&this.token)||(h(1,"请登陆后再调用此方法"),!1)}}})(),i})()));