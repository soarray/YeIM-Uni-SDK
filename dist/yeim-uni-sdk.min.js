!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{YeIMUniSDK:()=>ee,YeIMUniSDKDefines:()=>n,instance:()=>Z});var n={};function o(e,t=null){return{code:500,message:e,data:t}}function i(e,t,n=null){try{null!=e&&void 0!==e.success&&"function"==typeof e.success&&e.success(function(e,t=null){return{code:200,message:e,data:t}}(t,n))}catch(e){console.error(e)}}function s(e,t,n=null){try{null!=e&&void 0!==e.fail&&"function"==typeof e.fail&&e.fail(o(t,n))}catch(e){console.error(e)}}function r(e,t){uni.$emit(Z.defaults.eventPrefix+e,t)}function a(e,t){e&&uni.$on(Z.defaults.eventPrefix+e,t)}function l(e,t){e&&uni.$off(Z.defaults.eventPrefix+e,t)}n.EVENT={},n.EVENT.NET_CHANGED="net_changed",n.EVENT.CONVERSATION_LIST_CHANGED="conversation_list_changed",n.EVENT.MESSAGE_RECEIVED="message_received",n.EVENT.PRIVATE_READ_RECEIPT="private_read_receipt",n.EVENT.KICKED_OUT="kicked_out",n.CONVERSATION_TYPE={},n.CONVERSATION_TYPE.PRIVATE="private",n.CONVERSATION_TYPE.GROUP="group",n.MESSAGE_TYPE={},n.MESSAGE_TYPE.TEXT="text",n.MESSAGE_TYPE.IMAGE="image",n.MESSAGE_TYPE.AUDIO="audio",n.MESSAGE_TYPE.VIDEO="video",n.MESSAGE_TYPE.LOCATION="location",n.MESSAGE_TYPE.CUSTOM="custom";const c=function(e,t){if(0==Z.defaults.logLevel)console.log("【YeIMUniSDK Log】",t);else{if(2==Z.defaults.logLevel)return;1==e&&console.log("【YeIMUniSDK Log】",t)}};var u=function(e,t){return e<<t|e>>>32-t},d=function(e,t){var n,o,i,s,r;return i=2147483648&e,s=2147483648&t,r=(1073741823&e)+(1073741823&t),(n=1073741824&e)&(o=1073741824&t)?2147483648^r^i^s:n|o?1073741824&r?3221225472^r^i^s:1073741824^r^i^s:r^i^s},f=function(e,t,n,o,i,s,r){return e=d(e,d(d(function(e,t,n){return e&t|~e&n}(t,n,o),i),r)),d(u(e,s),t)},h=function(e,t,n,o,i,s,r){return e=d(e,d(d(function(e,t,n){return e&n|t&~n}(t,n,o),i),r)),d(u(e,s),t)},g=function(e,t,n,o,i,s,r){return e=d(e,d(d(function(e,t,n){return e^t^n}(t,n,o),i),r)),d(u(e,s),t)},p=function(e,t,n,o,i,s,r){return e=d(e,d(d(function(e,t,n){return t^(e|~n)}(t,n,o),i),r)),d(u(e,s),t)},m=function(e){var t,n="",o="";for(t=0;t<=3;t++)n+=(o="0"+(e>>>8*t&255).toString(16)).substr(o.length-2,2);return n};const y=function(e){e+="";var t,n,o,i,s,r,a,l,c,u=Array();for(e=function(e){e=e.replace(/\x0d\x0a/g,"\n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t}(e),u=function(e){for(var t,n=e.length,o=n+8,i=16*((o-o%64)/64+1),s=Array(i-1),r=0,a=0;a<n;)r=a%4*8,s[t=(a-a%4)/4]=s[t]|e.charCodeAt(a)<<r,a++;return r=a%4*8,s[t=(a-a%4)/4]=s[t]|128<<r,s[i-2]=n<<3,s[i-1]=n>>>29,s}(e),r=1732584193,a=4023233417,l=2562383102,c=271733878,t=0;t<u.length;t+=16)n=r,o=a,i=l,s=c,r=f(r,a,l,c,u[t+0],7,3614090360),c=f(c,r,a,l,u[t+1],12,3905402710),l=f(l,c,r,a,u[t+2],17,606105819),a=f(a,l,c,r,u[t+3],22,3250441966),r=f(r,a,l,c,u[t+4],7,4118548399),c=f(c,r,a,l,u[t+5],12,1200080426),l=f(l,c,r,a,u[t+6],17,2821735955),a=f(a,l,c,r,u[t+7],22,4249261313),r=f(r,a,l,c,u[t+8],7,1770035416),c=f(c,r,a,l,u[t+9],12,2336552879),l=f(l,c,r,a,u[t+10],17,4294925233),a=f(a,l,c,r,u[t+11],22,2304563134),r=f(r,a,l,c,u[t+12],7,1804603682),c=f(c,r,a,l,u[t+13],12,4254626195),l=f(l,c,r,a,u[t+14],17,2792965006),a=f(a,l,c,r,u[t+15],22,1236535329),r=h(r,a,l,c,u[t+1],5,4129170786),c=h(c,r,a,l,u[t+6],9,3225465664),l=h(l,c,r,a,u[t+11],14,643717713),a=h(a,l,c,r,u[t+0],20,3921069994),r=h(r,a,l,c,u[t+5],5,3593408605),c=h(c,r,a,l,u[t+10],9,38016083),l=h(l,c,r,a,u[t+15],14,3634488961),a=h(a,l,c,r,u[t+4],20,3889429448),r=h(r,a,l,c,u[t+9],5,568446438),c=h(c,r,a,l,u[t+14],9,3275163606),l=h(l,c,r,a,u[t+3],14,4107603335),a=h(a,l,c,r,u[t+8],20,1163531501),r=h(r,a,l,c,u[t+13],5,2850285829),c=h(c,r,a,l,u[t+2],9,4243563512),l=h(l,c,r,a,u[t+7],14,1735328473),a=h(a,l,c,r,u[t+12],20,2368359562),r=g(r,a,l,c,u[t+5],4,4294588738),c=g(c,r,a,l,u[t+8],11,2272392833),l=g(l,c,r,a,u[t+11],16,1839030562),a=g(a,l,c,r,u[t+14],23,4259657740),r=g(r,a,l,c,u[t+1],4,2763975236),c=g(c,r,a,l,u[t+4],11,1272893353),l=g(l,c,r,a,u[t+7],16,4139469664),a=g(a,l,c,r,u[t+10],23,3200236656),r=g(r,a,l,c,u[t+13],4,681279174),c=g(c,r,a,l,u[t+0],11,3936430074),l=g(l,c,r,a,u[t+3],16,3572445317),a=g(a,l,c,r,u[t+6],23,76029189),r=g(r,a,l,c,u[t+9],4,3654602809),c=g(c,r,a,l,u[t+12],11,3873151461),l=g(l,c,r,a,u[t+15],16,530742520),a=g(a,l,c,r,u[t+2],23,3299628645),r=p(r,a,l,c,u[t+0],6,4096336452),c=p(c,r,a,l,u[t+7],10,1126891415),l=p(l,c,r,a,u[t+14],15,2878612391),a=p(a,l,c,r,u[t+5],21,4237533241),r=p(r,a,l,c,u[t+12],6,1700485571),c=p(c,r,a,l,u[t+3],10,2399980690),l=p(l,c,r,a,u[t+10],15,4293915773),a=p(a,l,c,r,u[t+1],21,2240044497),r=p(r,a,l,c,u[t+8],6,1873313359),c=p(c,r,a,l,u[t+15],10,4264355552),l=p(l,c,r,a,u[t+6],15,2734768916),a=p(a,l,c,r,u[t+13],21,1309151649),r=p(r,a,l,c,u[t+4],6,4149444226),c=p(c,r,a,l,u[t+11],10,3174756917),l=p(l,c,r,a,u[t+2],15,718787259),a=p(a,l,c,r,u[t+9],21,3951481745),r=d(r,n),a=d(a,o),l=d(l,i),c=d(c,s);return(m(r)+m(a)+m(l)+m(c)).toLowerCase()};var v,I,P,T,S,E=E||function(e,t){var n={},o=n.lib={},i=function(){},s=o.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},r=o.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||l).stringify(this)},concat:function(e){var t=this.words,n=e.words,o=this.sigBytes;if(e=e.sigBytes,this.clamp(),o%4)for(var i=0;i<e;i++)t[o+i>>>2]|=(n[i>>>2]>>>24-i%4*8&255)<<24-(o+i)%4*8;else if(65535<n.length)for(i=0;i<e;i+=4)t[o+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],o=0;o<t;o+=4)n.push(4294967296*e.random()|0);return new r.init(n,t)}}),a=n.enc={},l=a.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],o=0;o<e;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],o=0;o<t;o+=2)n[o>>>3]|=parseInt(e.substr(o,2),16)<<24-o%8*4;return new r.init(n,t/2)}},c=a.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],o=0;o<e;o++)n.push(String.fromCharCode(t[o>>>2]>>>24-o%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],o=0;o<t;o++)n[o>>>2]|=(255&e.charCodeAt(o))<<24-o%4*8;return new r.init(n,t)}},u=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},d=o.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new r.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,o=n.words,i=n.sigBytes,s=this.blockSize,a=i/(4*s);if(t=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,i=e.min(4*t,i),t){for(var l=0;l<t;l+=s)this._doProcessBlock(o,l);l=o.splice(0,t),n.sigBytes-=i}return new r.init(l,i)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});o.Hasher=d.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new f.HMAC.init(e,n).finalize(t)}}});var f=n.algo={};return n}(Math);I=(S=(v=E).lib).WordArray,P=S.Hasher,T=[],S=v.algo.SHA1=P.extend({_doReset:function(){this._hash=new I.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,o=n[0],i=n[1],s=n[2],r=n[3],a=n[4],l=0;80>l;l++){if(16>l)T[l]=0|e[t+l];else{var c=T[l-3]^T[l-8]^T[l-14]^T[l-16];T[l]=c<<1|c>>>31}c=(o<<5|o>>>27)+a+T[l],c=20>l?c+(1518500249+(i&s|~i&r)):40>l?c+(1859775393+(i^s^r)):60>l?c+((i&s|i&r|s&r)-1894007588):c+((i^s^r)-899497514),a=r,r=s,s=i<<30|i>>>2,i=o,o=c}n[0]=n[0]+o|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+r|0,n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,o=8*e.sigBytes;return t[o>>>5]|=128<<24-o%32,t[14+(o+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(o+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=P.clone.call(this);return e._hash=this._hash.clone(),e}}),v.SHA1=P._createHelper(S),v.HmacSHA1=P._createHmacHelper(S),function(){var e=E,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=new e.init,"string"==typeof n&&(n=t.parse(n));var o=e.blockSize,i=4*o;n.sigBytes>i&&(n=e.finalize(n)),n.clamp();for(var s=this._oKey=n.clone(),r=this._iKey=n.clone(),a=s.words,l=r.words,c=0;c<o;c++)a[c]^=1549556828,l[c]^=909522486;s.sigBytes=r.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}();const b=E;async function k(){let[e,t]=await uni.request({url:Z.defaults.baseURL+"/upload/sign",data:{},method:"GET",header:{"content-type":"application/json",token:Z.token}});if(t&&t.data&&t.data.data){let e=t.data.data;Z.mediaUploadParams=e}else c(1,"媒体上传参数获取失败！")}function _(){let e="";return"cos"==Z.mediaUploadParams.storage?e="https://"+Z.mediaUploadParams.bucket+".cos."+Z.mediaUploadParams.region+".myqcloud.com":"oss"==Z.mediaUploadParams.storage?e="https://"+Z.mediaUploadParams.bucket+"."+Z.mediaUploadParams.region+".aliyuncs.com":"local"==Z.mediaUploadParams.storage&&(e=Z.defaults.baseURL),e}function U(){return Z.mediaUploadParams.customDomain?Z.mediaUploadParams.customDomain:_()}function C(e,t="files"){let n=e;if(!Z.mediaUploadParams.baseDir&&"local"==!Z.mediaUploadParams.storage)return n;{let o=Z.mediaUploadParams.baseDir,i=t+"/"+(new Date).toLocaleDateString().split("/").map((e=>e<10?"0"+e:e)).join("")+"/"+e;if("local"!=Z.mediaUploadParams.storage){if("/"==o.substring(0,1)&&(o=o.substring(1)),"/"==o.substring(o.length-1,o.length)&&(o=o.substring(0,o.length)+o.substring(o.length+1)),!o)return i;n=o+"/"+i}else n=i}return n}async function w(e,t,n){let o=parseInt((new Date).getTime()/1e3)-1;(!Z.mediaUploadParams||o>Z.mediaUploadParams.expireTime)&&await k();let i=Z.mediaUploadParams.nowTime,s=Z.mediaUploadParams.expireTime,r=Z.mediaUploadParams.secretId,a=i+";"+s,l=i+";"+s,c=Z.mediaUploadParams.signKey,u=e+"\n"+t+"\n\n"+n+"\n",d="sha1\n"+l+"\n"+b.SHA1(u)+"\n";return"q-sign-algorithm=sha1&q-ak="+r+"&q-sign-time="+a+"&q-key-time="+l+"&q-header-list=&q-url-param-list=&q-signature="+b.HmacSHA1(d,c)}async function A(){let e=parseInt((new Date).getTime()/1e3)-1;return(!Z.mediaUploadParams||e>Z.mediaUploadParams.expireTime)&&await k(),Z.mediaUploadParams}function x(e){if(!Z.checkLogged())return s(e,"请登陆后再试");if(!Z.mediaUploadParams)return c(1,"上传参数获取失败！");let t=Z.mediaUploadParams,n=e.filename.substring(e.filename.lastIndexOf(".")),o=y((new Date).getTime()+"_"+e.filename)+"_other"+n,r=_(),a=U()+"/"+C(o);if("cos"==t.storage)setTimeout((async()=>{let t=await w("post","/",""),n=uni.uploadFile({url:r,name:"file",formData:{key:C(o),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:t=>{i(e,"success",{url:a})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"==t.storage)setTimeout((async()=>{await A();let n=uni.uploadFile({url:r,name:"file",formData:{key:C(o),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,success:t=>{i(e,"success",{url:a})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"==t.storage){let t=uni.uploadFile({url:r+"/upload",name:"file",formData:{key:C(o)},header:{token:Z.token},filePath:e.filepath,success:t=>{let n=JSON.parse(t.data);200==n.code?i(e,"success",{url:U()+n.data.url}):s(e,n.message)},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}function M(e){if(!Z.mediaUploadParams)return c(1,"媒体上传参数获取失败！");let t=Z.mediaUploadParams,n=e.filename.substring(e.filename.lastIndexOf(".")),o=y((new Date).getTime()+"_"+e.filename)+"_image"+n,r=_(),a=U()+"/"+C(o,"image");if("cos"==t.storage)setTimeout((async()=>{let t=await w("post","/",""),n=uni.uploadFile({url:r,name:"file",formData:{key:C(o,"image"),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:()=>{let t=0,n=0;if(e.height>198){let o=198/e.height;t=parseInt(e.height*o),n=parseInt(e.width*o)}else if(e.width>198){let o=198/e.width;t=parseInt(e.height*o),n=parseInt(e.width*o)}i(e,"success",{url:a,thumbnailUrl:a+"?imageMogr2/thumbnail/"+n+"x"+t,thumbnailWidth:n,thumbnailHeight:t})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"==t.storage)setTimeout((async()=>{await A();let n=uni.uploadFile({url:r,name:"file",formData:{key:C(o,"image"),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,success:()=>{let t=0,n=0;if(e.height>198){let o=198/e.height;t=parseInt(e.height*o),n=parseInt(e.width*o)}else if(e.width>198){let o=198/e.width;t=parseInt(e.height*o),n=parseInt(e.width*o)}i(e,"success",{url:a,thumbnailUrl:a+"?x-oss-process=image/resize,m_fixed,h_"+t+",w_"+n,thumbnailWidth:n,thumbnailHeight:t})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"==t.storage){console.log(C(o,"image"));let t=uni.uploadFile({url:r+"/upload/image",name:"file",formData:{key:C(o,"image")},header:{token:Z.token},filePath:e.filepath,success:t=>{let n=JSON.parse(t.data);200==n.code?i(e,"success",{url:U()+n.data.url,thumbnailUrl:U()+n.data.thumbnailUrl,thumbnailWidth:n.data.thumbnailWidth,thumbnailHeight:n.data.thumbnailHeight}):s(e,n.message)},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}const O=function(e){return{conversationId:e.to,conversationType:e.conversationType,fromUserInfo:{nickname:Z.user.nickname,avatarUrl:Z.user.avatarUrl},from:Z.userId,to:e.to,type:e.type,isRead:0,isRevoke:0,isDeleted:0,status:"unSend",time:(new Date).getTime(),body:e.body,extra:e.extra?e.extra:""}};function D(e){if(!Z.userId)return o("请登陆后再调用此接口");if(null==e||!e.toId)return o("toId 不能为空");if(!e.conversationType)return o("conversationType 不能为空");if(!e.body||!e.body.text)return o("text 不能为空");let t={to:e.toId,type:n.MESSAGE_TYPE.TEXT,conversationType:e.conversationType,body:{text:e.body.text}};return e.extra&&(t.extra=e.extra),O(t)}function L(e){if(!Z.userId)return o("请登陆后再调用此接口");if(null==e||!e.toId)return o("toId 不能为空");if(!e.conversationType)return o("conversationType 不能为空");if(!e.body||!e.body.file)return o("file 不能为空");if(!e.body.file.tempFilePath)return o("tempFilePath 不能为空");if(!e.body.file.width)return o("width 不能为空");if(!e.body.file.height)return o("height 不能为空");let t={to:e.toId,type:n.MESSAGE_TYPE.IMAGE,conversationType:e.conversationType,body:{originalUrl:e.body.file.tempFilePath,originalWidth:e.body.file.width,originalHeight:e.body.file.height,thumbnailUrl:e.body.file.tempFilePath,thumbnailWidth:e.body.file.width,thumbnailHeight:e.body.file.height}};e.extra&&(t.extra=e.extra);let i=O(t);return void 0!==e.onProgress&&"function"==typeof e.onProgress&&(i.onProgress=e.onProgress),i}function N(e){if(!Z.userId)return o("请登陆后再调用此接口");if(null==e||!e.toId)return o("toId 不能为空");if(!e.conversationType)return o("conversationType 不能为空");if(!e.body.address)return o("address 不能为空");if(!e.body.description)return o("description 不能为空");if(!e.body.longitude)return o("longitude 不能为空");if(!e.body.latitude)return o("latitude 不能为空");let t={to:e.toId,type:n.MESSAGE_TYPE.LOCATION,conversationType:e.conversationType,body:{address:e.body.address,description:e.body.description,longitude:e.body.longitude,latitude:e.body.latitude}};return e.extra&&(t.extra=e.extra),O(t)}function R(e){if(!Z.userId)return o("请登陆后再调用此接口");if(null==e||!e.toId)return o("toId 不能为空");if(!e.conversationType)return o("conversationType 不能为空");if(!e.body||!e.body.file)return o("file 不能为空");if(!e.body.file.tempFilePath)return o("tempFilePath 不能为空");if(!e.body.file.duration)return o("duration 不能为空");let t={to:e.toId,type:n.MESSAGE_TYPE.AUDIO,conversationType:e.conversationType,body:{audioUrl:e.body.file.tempFilePath,duration:e.body.file.duration}};e.extra&&(t.extra=e.extra);let i=O(t);return void 0!==e.onProgress&&"function"==typeof e.onProgress&&(i.onProgress=e.onProgress),i}function H(e){if(!Z.userId)return o("请登陆后再调用此接口");if(null==e||!e.toId)return o("toId 不能为空");if(!e.conversationType)return o("conversationType 不能为空");if(!e.body||!e.body.file)return o("file 不能为空");if(!e.body.file.tempFilePath)return o("tempFilePath 不能为空");if(!e.body.file.width)return o("width 不能为空");if(!e.body.file.height)return o("height 不能为空");let t={to:e.toId,type:n.MESSAGE_TYPE.VIDEO,conversationType:e.conversationType,body:{videoUrl:e.body.file.tempFilePath,thumbnailUrl:null,videoWidth:e.body.file.width,videoHeight:e.body.file.height}};e.extra&&(t.extra=e.extra);let i=O(t);return void 0!==e.onProgress&&"function"==typeof e.onProgress&&(i.onProgress=e.onProgress),i}function G(e){if(!Z.userId)return o("请登陆后再试");if(null==e||!e.toId)return o("toId 不能为空");if(!e.conversationType)return o("conversationType 不能为空");if(!e.body)return o("自定义消息的 body 不能为空");let t={to:e.toId,type:n.MESSAGE_TYPE.CUSTOM,conversationType:e.conversationType,body:e.body};return e.extra&&(t.extra=e.extra),O(t)}function V(e){if(!Z.checkLogged())return s(e,"请登陆后再试");if(!e.message)return s(e,"message 不能为空");let t=e.message;t.type==n.MESSAGE_TYPE.TEXT?B(e):t.type==n.MESSAGE_TYPE.IMAGE?function(e){let t=e.message;M({filename:Z.token+"_image.png",filepath:t.body.originalUrl,width:t.body.originalWidth,height:t.body.originalHeight,success:n=>{t.body.originalUrl=n.data.url,t.body.thumbnailWidth=n.data.thumbnailWidth,t.body.thumbnailHeight=n.data.thumbnailHeight,t.body.thumbnailUrl=n.data.thumbnailUrl,e.message=t,B(e)},fail:e=>{c(1,e)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(e):t.type==n.MESSAGE_TYPE.VIDEO?function(e){let t=e.message;!function(e){if(!Z.mediaUploadParams)return c(1,"媒体上传参数获取失败！");let t=Z.mediaUploadParams,n=e.filename.substring(e.filename.lastIndexOf(".")),o=y((new Date).getTime()+"_"+e.filename)+"_video"+n,r=_(),a=U()+"/"+C(o,"video");if("cos"==t.storage)setTimeout((async()=>{let t=await w("post","/",""),n=uni.uploadFile({url:r,name:"file",formData:{key:C(o,"video"),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:async()=>{let t=await w("get","/"+C(o,"video"),"");uni.downloadFile({url:r+"/"+C(o,"video")+"?ci-process=snapshot&time=1",header:{Authorization:t},success:t=>{200===t.statusCode?M({filename:y(o+t.tempFilePath)+"_videoThumb.jpg",filepath:t.tempFilePath,success:t=>{i(e,"success",{videoUrl:a,thumbnailUrl:t.data.url})},fail:t=>{s(e,t)}}):s(e,"腾讯云媒体截图接口：下载视频缩略图失败")},fail:t=>{s(e,"腾讯云媒体截图接口：下载视频缩略图失败")}})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"==t.storage)setTimeout((async()=>{await A();let n=uni.uploadFile({url:r,name:"file",formData:{key:C(o,"video"),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,success:t=>{i(e,"success",{videoUrl:a,thumbnailUrl:a+"?x-oss-process=video/snapshot,t_1000,f_jpg,m_fast"})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"==t.storage){let t=uni.uploadFile({url:r+"/upload/video",name:"file",formData:{key:C(o,"video")},header:{token:Z.token},filePath:e.filepath,success:t=>{let n=JSON.parse(t.data);200==n.code?i(e,"success",{videoUrl:U()+n.data.url,thumbnailUrl:U()+n.data.thumbnailUrl}):s(e,n.message)},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}({filename:Z.token+"_video.mp4",filepath:t.body.videoUrl,success:n=>{let o=n.data.videoUrl,i=n.data.thumbnailUrl;t.body.videoUrl=o,t.body.thumbnailUrl=i,e.message=t,B(e)},fail:e=>{c(1,e)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(e):t.type==n.MESSAGE_TYPE.AUDIO?function(e){let t=e.message;!function(e){if(!Z.mediaUploadParams)return c(1,"媒体上传参数获取失败！");let t=Z.mediaUploadParams,n=e.filename.substring(e.filename.lastIndexOf(".")),o=y((new Date).getTime()+"_"+e.filename)+"_audio"+n,r=_(),a=U()+"/"+C(o,"audio");if("cos"==t.storage)setTimeout((async()=>{let t=await w("post","/",""),n=uni.uploadFile({url:r,name:"file",formData:{key:C(o,"audio"),success_action_status:200,Signature:t,"Content-Type":""},header:{Authorization:t},filePath:e.filepath,success:t=>{i(e,"success",{url:a})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}),0);else if("oss"==t.storage)setTimeout((async()=>{await A();let n=uni.uploadFile({url:r,name:"file",formData:{key:C(o,"audio"),policy:t.policyBase64,OSSAccessKeyId:t.accessKeyId,success_action_status:200,signature:t.signature},filePath:e.filepath,success:t=>{i(e,"success",{url:a})},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&n.onProgressUpdate((t=>{e.onProgress(t)}))}));else if("local"==t.storage){let t=uni.uploadFile({url:r+"/upload",name:"file",formData:{key:C(o,"audio")},header:{token:Z.token},filePath:e.filepath,success:t=>{let n=JSON.parse(t.data);200==n.code?i(e,"success",{url:U()+n.data.url}):s(e,n.message)},fail:t=>{s(e,t)}});void 0!==e.onProgress&&"function"==typeof e.onProgress&&t.onProgressUpdate((t=>{e.onProgress(t)}))}}({filename:Z.token+"_audio.aac",filepath:t.body.audioUrl,success:n=>{let o=n.data.url;t.body.audioUrl=o,e.message=t,B(e)},fail:e=>{c(1,e)},onProgress:e=>{void 0!==t.onProgress&&"function"==typeof t.onProgress&&t.onProgress(e)}})}(e):t.type==n.MESSAGE_TYPE.LOCATION&&B(e)}function B(e){let t=e.message;uni.request({url:Z.defaults.baseURL+"/message/save",data:t,method:"POST",header:{"content-type":"application/json",token:Z.token},success:t=>{let n=t.data.data;F(n),i(e,"接口调用成功",n)},fail:t=>{s(e,t)}})}function F(e){if(!e.conversationId)return void c(1,"message.conversationId 不能为空");let t=K(e.conversationId),n=t.findIndex((t=>t.messageId===e.messageId)),o="yeim:messageList:"+y(Z.userId)+":conversationId:"+y(e.conversationId);-1===n?(t.push(e),uni.setStorageSync(o,t)):(t[n]=e,uni.setStorageSync(o,t))}function Y(e){if(!Z.checkLogged())return s(e,"请登陆后再试");if(!e.conversationId)return s(e,"conversationId 不能为空");if(e.page&&parseFloat(e.page)||(e.page=1),1!=e.page)return q(e,e.page);let t=K(e.conversationId);if(t.length<=0)q(e,e.page);else{let n="yeim:conversationList:"+y(Z.userId),o=uni.getStorageSync(n);if(o=o||[],o<=0)return s(e,"会话不存在");{let n=o.findIndex((t=>t.conversationId===e.conversationId));if(-1===n)return s({code:500,message:"会话不存在"},e);if(o[n].lastMessage.messageId==t[t.length-1].messageId)return i(e,"接口调用成功",t);q(e,e.page)}}}function K(e){let t="yeim:messageList:"+y(Z.userId)+":conversationId:"+y(e),n=uni.getStorageSync(t);return n=n||[],n.sort(((e,t)=>e.sequence-t.sequence)),n}function q(e,t=1){uni.request({url:Z.defaults.baseURL+"/message/list",data:{page:t,conversationId:e.conversationId},method:"GET",header:{"content-type":"application/json",token:Z.token},success:n=>{let o=n.data.data.records;if(o=o.reverse(),o.sort(((e,t)=>e.sequence-t.sequence)),i(e,"接口调用成功",o),1==t){let t="yeim:messageList:"+y(Z.userId)+":conversationId:"+y(e.conversationId);uni.setStorageSync(t,o)}},fail:t=>{s(e,t),c(1,t)}})}function j(e){return Z.checkLogged()?e.message?e.message.messageId?e.message.conversationId?void uni.request({url:Z.defaults.baseURL+"/message/revoke",data:{messageId:e.message.messageId},method:"GET",header:{"content-type":"application/json",token:Z.token},success:t=>{e.message.isRevoke=1,F(e.message),i(e,"撤回成功",e.message)},fail:t=>{c(1,t),s(e,t)}}):s(e,"message.conversationId 不能为空"):s(e,"message.messageId 不能为空"):s(e,"message 不能为空"):s(e,"请登陆后再试")}function z(e=1,t=20){if(!Z.checkLogged())return errHandle(options,"请登陆后再试");let n="yeim:conversationList:"+y(Z.userId),o=uni.getStorageSync(n);o=o||[];let i=(e-1)*t;return i+t>=o.length?o.slice(i,o.length):o.slice(i,i+t)}function W(e){let t="yeim:conversationList:"+y(Z.userId);uni.setStorageSync(t,e),r(n.EVENT.CONVERSATION_LIST_CHANGED,e)}function J(e){if(!Z.checkLogged())return errHandle(options,"请登陆后再试");let t="yeim:conversationList:"+y(Z.userId),o=uni.getStorageSync(t);o=o||[];let i=o.findIndex((t=>t.conversationId===e));-1!==i&&(o[i].unread=0,uni.setStorageSync(t,o)),uni.request({url:Z.defaults.baseURL+"/conversation/update/unread",data:{conversationId:e},method:"GET",header:{"content-type":"application/json",token:Z.token},success:e=>{},fail:e=>{c(1,e)}}),r(n.EVENT.CONVERSATION_LIST_CHANGED,o)}function $(e){if(!Z.checkLogged())return errHandle(options,"请登陆后再试");let t="yeim:conversationList:"+y(Z.userId),o=uni.getStorageSync(t);o=o||[];let i=o.findIndex((t=>t.conversationId===e));-1!==i&&(o.splice(i,1),uni.setStorageSync(t,o));let s="yeim:messageList:"+y(Z.userId)+":conversationId:"+y(e);uni.removeStorageSync(s),uni.request({url:Z.defaults.baseURL+"/conversation/delete",data:{conversationId:e},method:"GET",header:{"content-type":"application/json",token:Z.token},success:e=>{},fail:e=>{c(1,e)}}),r(n.EVENT.CONVERSATION_LIST_CHANGED,o)}function X(e){return Z.checkLogged()?e.userId?void uni.request({url:Z.defaults.baseURL+"/user/info",data:{userId:e.userId},method:"GET",header:{token:Z.token},success:t=>{i(e,"接口调用成功",t.data.data)},fail:t=>{s(e,t),log(1,t)}}):s(e,"userId 不能为空"):s(e,"请登陆后再试")}function Q(e){return Z.checkLogged()?e.nickname?e.avatarUrl?void uni.request({url:Z.defaults.baseURL+"/user/update",data:{nickname:e.nickname,avatarUrl:e.avatarUrl},method:"POST",header:{"content-type":"application/json",token:Z.token},success:t=>{i(e,"接口调用成功")},fail:t=>{s(e,t),log(1,t)}}):s(e,"avatarUrl 不能为空"):s(e,"nickname 不能为空"):s(e,"请登陆后再试")}let Z;class ee{constructor(e={}){this.defaults={eventPrefix:"YeIM_",reConnectTotal:15,reConnectInterval:3e3,heartInterval:3e4,logLevel:0,...e},this.version="1.0.8",this.firstConnect=!0,this.socketTask=void 0,this.socketLogged=!1,this.allowReconnect=!0,this.lockReconnect=!1,this.reConnectNum=0,this.connectTimer=void 0,this.heartTimer=null,this.checkTimer=null,this.user={},this.userId=void 0,this.token=void 0,this.mediaUploadParams={}}static init(e={}){return Z||(Z=new ee(e),ee.prototype.createTextMessage=D,ee.prototype.createImageMessage=L,ee.prototype.createAudioMessage=R,ee.prototype.createVideoMessage=H,ee.prototype.createLocationMessage=N,ee.prototype.createCustomMessage=G,ee.prototype.upload=x,ee.prototype.sendMessage=V,ee.prototype.getMessageList=Y,ee.prototype.revokeMessage=j,ee.prototype.getConversationList=z,ee.prototype.clearConversationUnread=J,ee.prototype.deleteConversation=$,ee.prototype.getUserInfo=X,ee.prototype.updateUserInfo=Q,ee.prototype.addEventListener=a,ee.prototype.removeEventListener=l,c(1,"============= YeIMUniSDK 初始化成功！版本号："+Z.version+" ============="),Z)}static getInstance(){return Z||null}connect(e={}){if(!e.userId)return s(e,"userId 不能为空");if(!e.token)return s(e,"token 不能为空");this.firstConnect&&(uni.onSocketOpen(this.socketOpen.bind(this)),uni.onSocketError(this.socketError.bind(this)),uni.onSocketClose(this.socketClose.bind(this)),uni.onSocketMessage(this.socketMessage.bind(this)));let t=this.defaults.socketURL+"/"+e.userId+"/"+e.token;this.socketTask=uni.connectSocket({url:t,success:e=>{},fail:e=>{},complete:()=>{}}),this.firstConnect=!1,this.connectTimer=setTimeout((()=>(this.connectTimer=void 0,c(1,"连接服务端失败，请检查配置"),s(e,"网络异常，请稍后重试"))),2e3),this.socketTask.onMessage((t=>{if(!this.connectTimer)return;clearTimeout(this.connectTimer),this.connectTimer=void 0;let n=JSON.parse(t.data);if(201==n.code){this.socketTask.onMessage((()=>{}));let t=n.data.user;return this.user=t,this.userId=e.userId,this.token=e.token,this.socketLogged=!0,c(1,"IMServer登陆成功，登陆用户："+e.userId),function(e=1,t=20){uni.request({url:Z.defaults.baseURL+"/conversation/list",data:{page:e,limit:t},method:"GET",header:{"content-type":"application/json",token:Z.token},success:e=>{W(e.data.data.records)},fail:e=>{c(1,e)}})}(1,1e5),k(),i(e,"登陆成功",t)}return s(e,n.message)}))}disConnect(){this.allowReconnect=!1,uni.closeSocket()}reConnect(){if(this.allowReconnect&&!this.lockReconnect){if(!this.userId||!this.token)return void(this.allowReconnect=!1);if(this.defaults.reConnectTotal>0&&this.defaults.reConnectTotal<=this.reConnectNum)return void(this.allowReconnect=!1);this.reConnectNum++,this.lockReconnect=!0,r(n.EVENT.NET_CHANGED,"connecting"),setTimeout((()=>{c(1,"IMSDK 正在第"+this.reConnectNum+"次重连"),this.connect({userId:this.userId,token:this.token}),this.lockReconnect=!1}),this.defaults.reConnectInterval)}}readyState(){return this.socketTask?this.socketTask.readyState:3}startHeartTimer(){this.clearHeartTimer(),this.heartTimer=setTimeout((()=>{if(1==this.readyState()){let e={type:"heart",data:"ping"};uni.sendSocketMessage({data:JSON.stringify(e)}),this.checkTimer=setTimeout((()=>{uni.closeSocket()}),this.defaults.heartInterval)}}),this.defaults.heartInterval)}clearHeartTimer(){return clearTimeout(this.heartTimer),clearTimeout(this.checkTimer),this}socketOpen(e){r(n.EVENT.NET_CHANGED,"connected")}socketClose(e){c(1,"YeIMUniSDK断开连接"),this.socketLogged=!1,r(n.EVENT.NET_CHANGED,"closed"),this.reConnect()}socketError(e){c(1,e),this.reConnect()}socketMessage(e){if(c(0,e),this.startHeartTimer(),!this.socketLogged)return;let t=JSON.parse(e.data);t?this.socketMessageHandle(t):c(1,e)}socketMessageHandle(e){if(200==e.code){let t=e.data;F(t),r(n.EVENT.MESSAGE_RECEIVED,t),this.notifySocketMessageReceived(t)}else 203==e.code?function(e){let t=z(1,1e5),n=t.findIndex((t=>t.conversationId===e.conversationId));-1===n||t.splice(n,1),t.unshift(e),W(t)}(e.data):205==e.code?function(e){if(!e)return c(1,"conversationId is null");let t="yeim:messageList:"+y(Z.userId)+":conversationId:"+y(e),o=uni.getStorageSync(t);if(o=o||[],o){let i=[];for(let e=0;e<o.length;e++){let t=o[e];"out"==t.direction&&(t.isRead=1,o[e].isRead=1,i.push(t))}uni.setStorageSync(t,o),r(n.EVENT.PRIVATE_READ_RECEIPT,{conversationId:e,list:i})}}(e.data.conversationId):109==e.code&&(this.allowReconnect=!1,this.clearHeartTimer(),uni.closeSocket(),r(n.EVENT.KICKED_OUT,!0),c(1,"用户："+this.userId+"，被踢下线了"))}notifySocketMessageReceived(e){let t={type:"received_call",data:e};uni.sendSocketMessage({data:JSON.stringify(t),fail:e=>{c(1,e)}})}checkLogged(){return!!(this.socketLogged&&this.userId&&this.token)||(c(1,"请登陆后再调用此方法"),!1)}}return t})()));